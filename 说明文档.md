# 项目说明文档（任务管理模块简化改造）

最后更新时间：2025-11-04 10:30（UTC+8）

## 一、项目规划
- 目标：对任务管理模块的“创建任务”流程进行简化，移除 JSON 配置模式，仅保留页面配置模式，保持原有功能完整性，提升可用性与易理解性。
- 范围：前端 UI 与交互；参数构建与保存逻辑；文档同步（变更记录与说明）。不涉及真实后端，仅模拟数据。

## 二、实施方案（高层）
1. 移除与 JSON 配置模式相关的所有 UI 元素与状态（hyperparameterMode、manualConfig、导入/导出模板按钮与逻辑）。
2. 统一配置来源为页面表单，确保 `task.config` 始终为对象结构，移除字符串 JSON 的兼容处理。
3. 清理引用：TaskManagement.tsx、TaskTypeManagement.tsx、DataPreprocessing.tsx 等文件中所有相关逻辑与类型定义。
4. 文档同步：更新 CHANGELOG 与 docs（ALIGNMENT/CONSENSUS/DESIGN/TASK/ACCEPTANCE/FINAL），并在此说明文档记录进度。
5. 预览与验证：运行本地开发服务器，进行 UI 回归检查并展示预览链接。

## 三、进度记录（按节点）
- 2025-11-04 17:10：项目管理顶栏「视图切换靠右展示 + 按钮样式统一」
  - 背景：根据 UI 规范，视图切换（网格/列表）应作为右侧独立分区靠右展示；同时顶栏按钮（查询/重置/视图切换）需要统一高度与间距，提升一致性。
  - 改造内容：
    - App.tsx：重构顶栏为左右分区布局；右侧通过 `ml-auto` 使“网格/列表”按钮组靠右显示；左侧保留“搜索/负责人/日期/查询/重置”。
    - 样式统一：按钮统一高度 `h-10 md:h-12`、内边距 `px-4`、组内间距 `gap-2`；视图切换按钮激活态 `default`、非激活态 `outline`；“重置”采用 `outline` 体现次级操作。
  - 验证方法：
    - 打开 http://localhost:3001/ → “项目管理”；观察顶栏右侧为“网格/列表”按钮组，左侧顺序为“搜索/负责人/日期/查询/重置”。
    - 切换“网格/列表”验证激活/非激活样式正确；不同窗口宽度下按钮高度与间距一致，移动端可换行但右侧按钮始终靠右。
    - 终端与控制台无报错，HMR 正常。
- 2025-11-04 16:20：项目管理列表在“日期选择器”和“网格/列表”按钮之间新增“查询/重置”按钮
  - 背景：用户要求在项目管理页的顶部工具栏中显式提供查询与重置入口，位置位于日期选择器与视图切换之间，以提升便捷性与一致性（与任务管理/Data 管理保持一致）。
  - 改造内容：
    - App.tsx：新增 `handleApplyProjectQuery`（浅拷贝 `projectDateRange` 触发轻量刷新，不改变筛选状态）与 `handleResetProjectFilters`（清空搜索、负责人与日期范围，并复位状态筛选为“全部状态”）；在日期 Popover 与视图切换按钮之间插入“查询/重置”按钮组。
  - 验证方法：
    - 本地预览 http://localhost:3001/ → 顶部工具栏在“开始日期 - 结束日期”右侧显示“查询/重置”；
    - 点击“查询”后列表按当前过滤条件显式刷新；点击“重置”后搜索/负责人/日期范围均清空，状态列筛选回到“全部状态”；
    - 终端与控制台无报错，Vite HMR 正常。
- 2025-11-04 14:30：移除任务管理页面中标题下方的“筛选条件”面板（红框区域），统一保留列头 Popover 作为唯一筛选入口；顶部操作栏继续保留“搜索/数据集名称/日期范围”。
  - 背景：用户明确要求“去掉红框内的部分”；同时我们已将常用筛选迁移到列头与顶部工具栏，面板保留会造成重复与空白。
  - 改造内容：
    - TaskManagement.tsx：删除筛选面板整块 JSX 条件渲染；保留列头筛选（任务类型/状态/所属项目/优先级/模型）。
    - 事件类型：对 onClick/onOpenAutoFocus 等回调参数添加类型注解，避免隐式 any（已有修正，此处保持一致）。
  - 验证方法：
    - `npm run dev` → http://localhost:3000/ → 任务管理页；
    - 标题下方不再显示“筛选条件”大面板；列头筛选弹出 Popover 正常，选择后列表即时过滤；顶部三项（搜索/数据集/日期范围）正常；
    - 终端与控制台无报错，HMR 生效。

- 2025-11-04 15:30：顶部右侧按钮替换为“查询/重置”
  - 背景：用户要求将“筛选”按钮去掉，改为“查询”和“重置”两个按钮，以显式触发和清空筛选。
  - 改造内容：
    - TaskManagement.tsx：移除 showFilters 状态与“筛选”按钮；新增 handleApplyQuery（浅拷贝触发刷新，不更改 filters）；在右侧工具栏加入“查询”和“重置”按钮，并分别绑定 handleApplyQuery 与 resetFilters。
  - 验证方法：
    - 本地预览 http://localhost:3000/：右侧出现“查询/重置”；点击“查询”列表按当前 filters 渲染（与响应式一致），点击“重置”清空所有筛选状态；控制台无报错。
- 2025-11-04 11:20：任务管理列表顶部工具栏—将“搜索/数据集名称/日期范围”三项移动至标题下方的红框位置（操作栏左侧），与右侧“筛选/视图切换/创建任务”同排显示；同时从下方筛选面板中移除这三项以避免重复，其他筛选项保留。
  - 背景：根据页面布局与使用频率，这三项是最高频的筛选操作，需要提升至顶部以便快速访问。
  - 改造内容：
    - TaskManagement.tsx 顶部操作栏改为 `flex justify-between items-center flex-wrap md:flex-nowrap`；新增左侧容器包含搜索输入、多选数据集 Popover、日期范围 Popover。
    - 移除筛选面板内对应的“搜索/数据集名称/日期范围”三项，保留任务类型、状态、所属项目、优先级、模型名称等。
    - 控件宽度：搜索约 280px，数据集约 260px，日期范围约 320px；均设置 `shrink-0` 以保证 md+ 不换行，移动端自动换行。
  - 验证方法：
    - 本地预览：`npm run dev` → http://localhost:3000/ → 任务管理页面。
    - 桌面端宽度（1280/1440/1920）观察顶部红框位置三项同一行展示；点击各控件验证 filters 状态更新与列表过滤生效；点击右侧“筛选”面板不含这三项但仍可重置/应用。
    - 控制台与终端检查：无新的错误日志。
- 2025-10-31 00:00：创建说明文档与 ALIGNMENT 文档，建立任务清单。
- 2025-10-31 00:15：完成以下改造并本地预览验证（无控制台错误）：
  - 移除“配置模式”单选切换与 JSON 文本域、导入/导出按钮（TaskManagement.tsx）。
  - 创建/编辑逻辑统一构建对象模式的 config（含 output 配置），时序预测兼容 mainVariableFile 字段（取 mainVariableFiles[0]）。
  - 表单初始值与弹窗重置移除 hyperparameterMode、manualConfig、config 等 JSON 模式字段。
  - 校验逻辑 validateForm 仅校验页面配置参数，移除与 JSON 模式相关校验。
  - 清理残留引用（已全局检索无 hyperparameterMode/manualConfig 引用）。
  - 为关键函数添加函数级注释（handleCreateTask、handleSaveEditTask）。
  - 本地预览地址：http://localhost:3000/。

- 2025-10-31 00:30：创建任务-第2步“数据集选择”占位文案由“选择已预处理的数据集”改为“选择数据集”，并完成本地预览验证（无控制台错误）。

- 2025-10-31 00:38：创建任务-第2步顺序与逻辑优化：将“数据版本”选择上移至“数据集详情”上方，并且仅在选择版本后显示详情预览。已完成本地预览验证（无控制台错误）。

- 2025-10-31 00:46：术语统一：将创建任务第2步中的“预测目标字段”改为“特征字段”，并同步校验提示文案（“最多只能选择10个特征字段”）。已完成本地预览验证（无控制台错误）。

- 2025-10-31 01:05：参数配置-输入配置新增“预测目标列”：在“时间列”右侧新增目标列选择（来自公共字段，排除当前时间列），并增加校验（必选、需在公共字段中、不可与时间列相同）。已完成本地预览验证（无控制台错误）。

- 2025-10-31 01:12：根据反馈，移除“预测目标列”下方的提示文案（通常为数值型时间序列），以减少页面冗余信息。已完成本地预览验证（无控制台错误）。

- 2025-10-31 01:45：任务状态与操作优化（列表页 + 详情页）已完成并本地预览验证：
  - 扩展任务状态枚举，新增“未开始(not_started)”，统一状态标签与图标（Circle），并将“pending”文案统一为“排队中”。
  - 操作映射：在 pending 状态下，主操作从“开始”改为“取消排队(cancel_queue)”；在 failed/cancelled 状态保留“重新运行(retry)”，并兼容 rerun；按钮颜色映射同步（取消排队走红色、重试/重新运行走蓝色）。
  - 二次确认弹窗：列表页与详情页均新增“取消排队”和“重新运行”的确认标题、提示文案与按钮样式。
  - 列表页执行逻辑：实现 cancel_queue 将状态从 pending→not_started，retry/rerun 将状态置为 pending 并清空进度；保留模拟网络请求与提示气泡。
  - 状态筛选器：新增“未开始”选项，过滤逻辑兼容。
  - 预览地址：http://localhost:3000/（已回归检查）。

- 2025-10-31 02:10：行为修正（取消排队后为“重新运行”）：
  - 列表页：在 cancel_queue 将状态设为 not_started 的同时，标记 hasQueuedBefore=true，使未开始状态的主操作显示为“重新运行”。
  - 详情页：Task 接口新增 hasQueuedBefore?: boolean，动作渲染使用共享映射，保持与列表页一致。
  - 工具：扩展 src/utils/taskActions.ts 的 getAvailableActions/getCommonActionKeys 以在 not_started + hasQueuedBefore 显示 retry；保留其他状态逻辑不变。
  - 预览地址：http://localhost:3000/（已回归检查）。

- 2025-10-31 02:36：详情页“本地状态覆盖”与即时回显：
  - 新增：在 TaskDetailFullPage 引入 localTaskOverrides + computedTask 合并策略；在详情页执行 start/stop/retry/rerun/cancel_queue/archive 时，立即覆盖本地状态。
  - UI：
    - 状态徽章改为基于 computedTask.status 渲染，操作按钮集合改为基于 computedTask 调用 getAvailableActions。
    - 确保“取消排队”后立即显示“重新运行”，且按钮颜色/文案与列表页一致。
  - 影响范围：仅详情页前端展示（不影响外层任务列表数据源）。
  - 预览地址：http://localhost:3000/（已回归检查）。

- 2025-10-31 02:52：详情页与列表状态同步（onTaskPatched 桥接链路）
  - TaskDetailFullPage.tsx：为 props 增加 onTaskPatched，并在 applyTaskOverrides 中调用以上报补丁。
  - App.tsx：新增 externalTaskPatch 与 handleTaskPatched；将补丁合并到 selectedTaskForFullPage，并把 externalTaskPatch 透传给 TaskManagement。
  - TaskManagement.tsx：新增 externalTaskPatch props 与 useEffect 合并逻辑，将补丁同步到本地 tasks 列表。
  - 预览与验证：启动 DevServer（http://localhost:3000/），执行“取消排队/重新运行”后，详情页与列表一致，控制台无错误。

后续节点将根据执行情况即时更新。

— 2025-11-03 00:00：任务详情页「显示训练数据」开关与结果叠加（原型）—
- 结果区域新增开关（默认关闭），位置：预测结果表卡片右上角，遵循现有 UI 风格（Switch + 标签），含 hover/active 样式。
- 数据层：
  - 训练数据 mock：forecastTrainSeries、forecastingTrainResiduals、forecastingTrainPredVsActual、trainMetricTrend、forecastingErrorHistogram（返回 test/train 两套计数）。
  - 合并：combinedMetricTrend（RMSE/MAPE 测试+训练）、combinedForecastLineData（时序真实/预测 + 训练真实/预测）、combinedForecastRows（表格行，新增 dataset 字段）。
- 表格：在“预测结果表”增加“数据集”列（Badge 区分 测试=蓝、训练=紫），分页与 CSV 导出均基于合并数据；打开开关后，导出附加 dataset 列。
- 图表（不新增图表，只做叠加）：
  - 指标趋势：切换为 combinedMetricTrend；训练集曲线使用虚线与淡色区分，图例标注（测试/训练）。
  - 时序预测曲线：同一图中叠加训练真实/预测，采用虚线与淡色。
  - 散点图（预测值 vs 真实值）：叠加训练集散点（淡色）。
  - 残差图：叠加训练集残差散点（淡色）。
  - 误差分布直方图：在开启开关时切换为双柱（testCount/trainCount）分栏对比。
- 分类任务指标报表：在开启开关时，同卡片内附加训练值（二级文案，紫色强调），不改变卡片结构。
- 预览验证：通过 Vite DevServer (http://localhost:3000/) 本地检查，切换无明显延迟，控制台无错误。

— 2025-11-03 09:30：数据管理-高级筛选改造（大小范围→列数范围；移除完整度范围）—
- 背景：根据产品要求，高级筛选中“大小范围 (MB)”不再符合使用场景，需改为“列数范围”；同时移除“完整度范围”筛选项。
- 改造内容：
  - 状态与逻辑：advancedFilters.sizeRange 替换为 columnsRange；移除 completenessRange。
  - UI：高级筛选弹窗中将“大小范围 (MB)”改为“列数范围”，移除“完整度范围”输入区域；清除按钮与重置逻辑同步更新。
  - 国际化：新增 i18n 键 data.filter.columnsRange（zh: 列数范围；en: Columns Range）。
- 验证：
  - 启动本地预览：`npm run dev` → http://localhost:3000/。
  - 路径：“数据管理 → 高级筛选”。
  - 结果：弹窗中显示“列数范围”，不再显示“完整度范围”；应用后列表按列数范围正确过滤；切换中英文文案正确。
  - 控制台：无报错。

— 2025-11-04 09:00：数据管理-移除“高级筛选”弹窗并改为顶部“查询”按钮（国际化）—
- 背景：减少不必要弹窗，统一筛选体验；顶部筛选输入（标签、日期范围）保持即时生效，“查询”仅作为显式触发动作。
- 改造内容：
  - 删除 isAdvancedFilterOpen 状态与相关引用；移除高级筛选弹窗的完整 JSX 渲染块。
  - 新增 handleApplyQuery 函数：浅拷贝当前 advancedFilters 以触发查询动作，不更改状态、不弹窗；添加函数级注释。
  - 顶栏按钮文案改为使用 i18n 键 `data.filter.query`（zh: 查询；en: Query）。
  - 保留 advancedFilters 作为顶部控件的即时筛选状态（标签检索与日期范围）。
- 文件改动：
  - src/components/DataManagement.tsx（删除 isAdvancedFilterOpen 与弹窗 JSX；新增 handleApplyQuery；替换按钮文案与点击事件）。
  - src/i18n/LanguageContext.tsx（新增 `data.filter.query` 键）。
- 预览与验证：`npm run dev` → http://localhost:3000/ 打开“数据管理”页；确认顶部显示“查询”按钮，点击不弹窗；标签与日期选择即时过滤；控制台无报错。


## 四、风险与应对
- 风险：遗留引用导致编译错误；任务类型页面的相关入口遗漏；文档与代码不同步；externalTaskPatch 多次应用导致潜在重复覆盖。
- 应对：全局检索关键字段；分阶段提交补丁；每次修改后立即本地预览验证；完成后统一更新文档；externalTaskPatch 合并采用幂等覆盖策略，重复传递不产生副作用。

## 五、质量要求
- 函数级注释完整（功能、参数、返回值）。
- 简化后仍保留原有功能项（页面配置参数、校验、任务保存与编辑）。
- 无未使用变量与死代码；UI 清晰一致。

附：阶段性自检结论
- UI：参数配置页已仅展示页面配置，无模式切换；编辑旧任务时可正确回显对象配置。
- 逻辑：创建/编辑保存均写入对象结构的 config；时序预测 mainVariableFile 兼容处理已完成。
- 编译与预览：DevServer 正常运行，预览未见错误。
— 2025-11-04 10:30：项目管理列表「状态列筛选 + 创建/更新时间排序」—
- 背景：提升列表可用性与一致性，支持列级筛选与就地排序；保持与顶部筛选器联动。
- 改造内容：
  - 在列表表头“状态”列新增筛选 Popover（图标按钮），复用顶部 statusFilter 状态；选择后即时过滤，顶部选择与列筛选任一修改都会同步生效。
  - 为“创建时间/更新时间”列表头新增排序交互（点击切换升/降序）；新增排序状态 projectSortField（createdTime|updatedTime）与 projectSortOrder（asc|desc），并通过 sortedProjects 渲染列表与网格视图。
- 文件改动：
  - src/App.tsx（新增排序状态与 handleToggleProjectSort；表头插入 Popover 与 ArrowUpDown；列表/网格改用 sortedProjects）。
- 预览与验证：`npm run dev` → http://localhost:3001/ → 切换到“列表”视图；
  - 点击“状态”列的筛选图标选择状态，列表过滤正确，顶部状态选择保持一致；
  - 点击“创建时间/更新时间”表头可交替升序/降序排序；
  - 控制台无报错。

— 2025-11-04 11:45：项目管理-移除顶部“全部状态”筛选框与“暂停”选项—
- 背景：根据最新需求，去掉“暂停”功能；同时精简顶部工具栏，移除“全部状态”筛选框，统一使用列表表头“状态”列 Popover 进行筛选。
- 改造内容：
  - 删除顶部工具栏的“全部状态” Select 控件；
  - 从“状态”列 Popover 选项中移除“暂停”；
  - 清理筛选逻辑中针对“暂停”的兼容映射（不再与“已延期”相关联）。
- 文件改动：
  - src/App.tsx（删除顶部筛选 Select；移除 Popover 中“暂停”；删除过滤逻辑对“暂停”的兼容映射）。
  - project.md（去掉“暂停”状态与操作描述；明确顶部不再提供“全部状态”筛选框）。
- 预览与验证：`npm run dev` → 项目管理页；
  - 顶部不再显示“全部状态”筛选框；
  - “状态”列 Popover 中不含“暂停”选项；
  - 选择其他状态过滤正常，控制台无报错。

— 2025-11-04 12:20：项目管理-工具栏“搜索/负责人/日期筛选”同排展示（搜索框变短）—
- 背景：根据用户需求，顶部“搜索项目”输入框需变短，并与“全部负责人”和“日期筛选”在同一行展示；移动端需自动换行以保持可用。
- 改造内容：
  - 容器布局：将原“搜索框”独立一行改为与筛选并排的 flex 布局，使用 `flex flex-col md:flex-row md:items-center md:justify-between gap-4`，实现桌面端同排、移动端自动换行。
  - 搜索框：宽度调整为 `w-full md:w-[280px]`，高度 `h-10 md:h-12`，占位仍为“搜索项目”。
  - 负责人筛选：保留 `SelectTrigger w-32 md:w-36`，不改变交互逻辑。
  - 日期范围：触发按钮宽度由 `w-[320px]` 改为 `w-[260px]`，内部文案与选择逻辑保持不变。
- 文件改动：
  - src/App.tsx（合并顶部布局，调整各控件宽度；保留筛选逻辑与视图切换按钮）。
- 预览与验证：
  - 桌面端（1280/1440/1920 宽度）：搜索框、负责人筛选、日期筛选三项在一行展示；
  - 移动端（<768px）：同区域自动按需换行，交互不受影响；
  - 功能验证：搜索/负责人/日期范围过滤行为保持一致，控制台无报错；
  - 预览地址：http://localhost:3000/。

— 2025-11-04 13:10：项目管理-将“网格/列表”视图切换并入同一行（与搜索条件同排）—
- 背景：为减少顶部空白与视线移动，将视图切换与搜索/筛选控件放在同一行；在桌面端需保证不换行。
- 改造内容：
  - 顶部容器从“左右分栏（md:flex-row md:justify-between）”改为“单一容器同排（flex items-center gap-3 flex-wrap md:flex-nowrap）”；
  - 将“网格/列表”按钮组并入与搜索/负责人/日期按钮相同的容器末尾，并设置 `shrink-0`；
  - 控件宽度：搜索框 `w-[240px] md:w-[280px]`，负责人下拉 `w-32 md:w-36`，日期按钮 `w-[240px] md:w-[260px]`，按钮组保持 `w-20` 宽度；整体使用 `gap-3` 以减少占用。
- 文件改动：
  - src/App.tsx（合并容器、移动按钮组位置、添加 `shrink-0` 与固定宽度）。
- 预览与验证：
  - 桌面端（>=768px）：搜索/负责人/日期/网格/列表五项同一行展示；
  - 移动端（<768px）：该行按需自动换行，但所有控件均可点击；
  - 预览地址：http://localhost:3000/；控制台无报错。

— 2025-11-04 13:45：任务管理-将“任务类型/状态/所属项目/优先级”四项筛选迁移到任务列表列头筛选 —
- 背景：根据用户需求，上述四项筛选需从下方筛选面板迁移到列表表头的列级筛选中，以便就地过滤并减少视线移动。
- 改造内容：
  - 在任务列表表头的“任务类型/状态/所属项目/优先级”四个列上新增筛选 Popover（图标按钮，紧邻列名），内部使用 Select/Checkbox 复用原有选项与翻译；点击选项即时更新 filters 状态；支持“清除/重置”为“全部”。
  - 保留表头原有排序点击行为（如创建时间列的升/降序），与筛选图标点击互不干扰；筛选图标采用小范围点击区域避免误触排序。
  - 从下方筛选面板中移除这四项，以避免重复；其他面板项（如模型名称）保留不变。
  - 状态联动：列头筛选与全局 filters 使用同一状态源（handleFilterChange），支持在任一位置修改后另一处即时同步。
- 文件改动：
  - src/components/TaskManagement.tsx（为四个列头插入 Popover + Select；移除筛选面板中的对应四项；保留排序交互）。
- 预览与验证：
  - 启动 DevServer：`npm run dev` → http://localhost:3000/。
  - 路径：任务管理页 → 任务列表。
  - 验证点：
    1) 点击四个列头的筛选图标弹出 Popover；
    2) 在 Popover 中选择任意值后列表即时过滤；再次打开看到选中态正确；
    3) 点击列名进行排序不受筛选图标影响；
    4) 从筛选面板中不再看到这四项；
    5) 控制台与终端无报错（Vite 本地地址显示为 http://localhost:3000/）。
- 截图与微调建议：如需调整图标样式、间距或移动端表现，请提供截图与具体要求（例如：图标与列名的间距、是否需要分隔线、默认选项是否为“全部”等）。

— 2025-11-04 14:06：任务管理-将“模型名称”筛选迁移到任务列表“模型”列的列头筛选 —
- 背景：统一筛选体验，所有高频筛选项均在列表就地操作；模型筛选支持搜索与多选。
- 改造内容：
  - 在“模型”列表头新增筛选 Popover（小图标按钮），内部为 Command 搜索 + Checkbox 多选列表；可即时过滤，选中项在按钮上以高亮色提示。
  - 从下方筛选面板移除“模型名称”控件，避免重复；保留面板的重置/应用按钮（面板暂为空）。
  - 事件类型修正：为 onClick/onOpenAutoFocus 添加显式类型（React.MouseEvent<HTMLButtonElement> / Event），消除 TypeScript 隐式 any 诊断。
- 文件改动：
  - src/components/TaskManagement.tsx（在“模型”列插入 Popover；移除筛选面板的模型名称控件；补充类型注解）。
- 预览与验证：
  - DevServer：http://localhost:3000/ → 任务管理页。
  - 验证点：
    1) 点击“模型”列头右侧图标展开 Popover；
    2) 搜索框输入关键字可过滤模型选项；
    3) 勾选/取消勾选即时更新列表，按钮颜色根据是否选中高亮；
    4) 下方筛选面板不再显示“模型名称”。