# 项目说明文档（任务管理模块简化改造）

最后更新时间：2025-11-03 00:00（UTC+8）

## 一、项目规划
- 目标：对任务管理模块的“创建任务”流程进行简化，移除 JSON 配置模式，仅保留页面配置模式，保持原有功能完整性，提升可用性与易理解性。
- 范围：前端 UI 与交互；参数构建与保存逻辑；文档同步（变更记录与说明）。不涉及真实后端，仅模拟数据。

## 二、实施方案（高层）
1. 移除与 JSON 配置模式相关的所有 UI 元素与状态（hyperparameterMode、manualConfig、导入/导出模板按钮与逻辑）。
2. 统一配置来源为页面表单，确保 `task.config` 始终为对象结构，移除字符串 JSON 的兼容处理。
3. 清理引用：TaskManagement.tsx、TaskTypeManagement.tsx、DataPreprocessing.tsx 等文件中所有相关逻辑与类型定义。
4. 文档同步：更新 CHANGELOG 与 docs（ALIGNMENT/CONSENSUS/DESIGN/TASK/ACCEPTANCE/FINAL），并在此说明文档记录进度。
5. 预览与验证：运行本地开发服务器，进行 UI 回归检查并展示预览链接。

## 三、进度记录（按节点）
- 2025-10-31 00:00：创建说明文档与 ALIGNMENT 文档，建立任务清单。
- 2025-10-31 00:15：完成以下改造并本地预览验证（无控制台错误）：
  - 移除“配置模式”单选切换与 JSON 文本域、导入/导出按钮（TaskManagement.tsx）。
  - 创建/编辑逻辑统一构建对象模式的 config（含 output 配置），时序预测兼容 mainVariableFile 字段（取 mainVariableFiles[0]）。
  - 表单初始值与弹窗重置移除 hyperparameterMode、manualConfig、config 等 JSON 模式字段。
  - 校验逻辑 validateForm 仅校验页面配置参数，移除与 JSON 模式相关校验。
  - 清理残留引用（已全局检索无 hyperparameterMode/manualConfig 引用）。
  - 为关键函数添加函数级注释（handleCreateTask、handleSaveEditTask）。
  - 本地预览地址：http://localhost:3000/。

- 2025-10-31 00:30：创建任务-第2步“数据集选择”占位文案由“选择已预处理的数据集”改为“选择数据集”，并完成本地预览验证（无控制台错误）。

- 2025-10-31 00:38：创建任务-第2步顺序与逻辑优化：将“数据版本”选择上移至“数据集详情”上方，并且仅在选择版本后显示详情预览。已完成本地预览验证（无控制台错误）。

- 2025-10-31 00:46：术语统一：将创建任务第2步中的“预测目标字段”改为“特征字段”，并同步校验提示文案（“最多只能选择10个特征字段”）。已完成本地预览验证（无控制台错误）。

- 2025-10-31 01:05：参数配置-输入配置新增“预测目标列”：在“时间列”右侧新增目标列选择（来自公共字段，排除当前时间列），并增加校验（必选、需在公共字段中、不可与时间列相同）。已完成本地预览验证（无控制台错误）。

- 2025-10-31 01:12：根据反馈，移除“预测目标列”下方的提示文案（通常为数值型时间序列），以减少页面冗余信息。已完成本地预览验证（无控制台错误）。

- 2025-10-31 01:45：任务状态与操作优化（列表页 + 详情页）已完成并本地预览验证：
  - 扩展任务状态枚举，新增“未开始(not_started)”，统一状态标签与图标（Circle），并将“pending”文案统一为“排队中”。
  - 操作映射：在 pending 状态下，主操作从“开始”改为“取消排队(cancel_queue)”；在 failed/cancelled 状态保留“重新运行(retry)”，并兼容 rerun；按钮颜色映射同步（取消排队走红色、重试/重新运行走蓝色）。
  - 二次确认弹窗：列表页与详情页均新增“取消排队”和“重新运行”的确认标题、提示文案与按钮样式。
  - 列表页执行逻辑：实现 cancel_queue 将状态从 pending→not_started，retry/rerun 将状态置为 pending 并清空进度；保留模拟网络请求与提示气泡。
  - 状态筛选器：新增“未开始”选项，过滤逻辑兼容。
  - 预览地址：http://localhost:3000/（已回归检查）。

- 2025-10-31 02:10：行为修正（取消排队后为“重新运行”）：
  - 列表页：在 cancel_queue 将状态设为 not_started 的同时，标记 hasQueuedBefore=true，使未开始状态的主操作显示为“重新运行”。
  - 详情页：Task 接口新增 hasQueuedBefore?: boolean，动作渲染使用共享映射，保持与列表页一致。
  - 工具：扩展 src/utils/taskActions.ts 的 getAvailableActions/getCommonActionKeys 以在 not_started + hasQueuedBefore 显示 retry；保留其他状态逻辑不变。
  - 预览地址：http://localhost:3000/（已回归检查）。

- 2025-10-31 02:36：详情页“本地状态覆盖”与即时回显：
  - 新增：在 TaskDetailFullPage 引入 localTaskOverrides + computedTask 合并策略；在详情页执行 start/stop/retry/rerun/cancel_queue/archive 时，立即覆盖本地状态。
  - UI：
    - 状态徽章改为基于 computedTask.status 渲染，操作按钮集合改为基于 computedTask 调用 getAvailableActions。
    - 确保“取消排队”后立即显示“重新运行”，且按钮颜色/文案与列表页一致。
  - 影响范围：仅详情页前端展示（不影响外层任务列表数据源）。
  - 预览地址：http://localhost:3000/（已回归检查）。

- 2025-10-31 02:52：详情页与列表状态同步（onTaskPatched 桥接链路）
  - TaskDetailFullPage.tsx：为 props 增加 onTaskPatched，并在 applyTaskOverrides 中调用以上报补丁。
  - App.tsx：新增 externalTaskPatch 与 handleTaskPatched；将补丁合并到 selectedTaskForFullPage，并把 externalTaskPatch 透传给 TaskManagement。
  - TaskManagement.tsx：新增 externalTaskPatch props 与 useEffect 合并逻辑，将补丁同步到本地 tasks 列表。
  - 预览与验证：启动 DevServer（http://localhost:3000/），执行“取消排队/重新运行”后，详情页与列表一致，控制台无错误。

后续节点将根据执行情况即时更新。

— 2025-11-03 00:00：任务详情页「显示训练数据」开关与结果叠加（原型）—
- 结果区域新增开关（默认关闭），位置：预测结果表卡片右上角，遵循现有 UI 风格（Switch + 标签），含 hover/active 样式。
- 数据层：
  - 训练数据 mock：forecastTrainSeries、forecastingTrainResiduals、forecastingTrainPredVsActual、trainMetricTrend、forecastingErrorHistogram（返回 test/train 两套计数）。
  - 合并：combinedMetricTrend（RMSE/MAPE 测试+训练）、combinedForecastLineData（时序真实/预测 + 训练真实/预测）、combinedForecastRows（表格行，新增 dataset 字段）。
- 表格：在“预测结果表”增加“数据集”列（Badge 区分 测试=蓝、训练=紫），分页与 CSV 导出均基于合并数据；打开开关后，导出附加 dataset 列。
- 图表（不新增图表，只做叠加）：
  - 指标趋势：切换为 combinedMetricTrend；训练集曲线使用虚线与淡色区分，图例标注（测试/训练）。
  - 时序预测曲线：同一图中叠加训练真实/预测，采用虚线与淡色。
  - 散点图（预测值 vs 真实值）：叠加训练集散点（淡色）。
  - 残差图：叠加训练集残差散点（淡色）。
  - 误差分布直方图：在开启开关时切换为双柱（testCount/trainCount）分栏对比。
- 分类任务指标报表：在开启开关时，同卡片内附加训练值（二级文案，紫色强调），不改变卡片结构。
- 预览验证：通过 Vite DevServer (http://localhost:3000/) 本地检查，切换无明显延迟，控制台无错误。


## 四、风险与应对
- 风险：遗留引用导致编译错误；任务类型页面的相关入口遗漏；文档与代码不同步；externalTaskPatch 多次应用导致潜在重复覆盖。
- 应对：全局检索关键字段；分阶段提交补丁；每次修改后立即本地预览验证；完成后统一更新文档；externalTaskPatch 合并采用幂等覆盖策略，重复传递不产生副作用。

## 五、质量要求
- 函数级注释完整（功能、参数、返回值）。
- 简化后仍保留原有功能项（页面配置参数、校验、任务保存与编辑）。
- 无未使用变量与死代码；UI 清晰一致。

附：阶段性自检结论
- UI：参数配置页已仅展示页面配置，无模式切换；编辑旧任务时可正确回显对象配置。
- 逻辑：创建/编辑保存均写入对象结构的 config；时序预测 mainVariableFile 兼容处理已完成。
- 编译与预览：DevServer 正常运行，预览未见错误。