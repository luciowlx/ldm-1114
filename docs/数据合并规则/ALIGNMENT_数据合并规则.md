# 阶段1：Align（数据合并规则 - 公共字段改造）

## 1. 项目上下文分析
- 技术栈：React + TypeScript + Vite（Mac 环境），仅前端原型演示；数据均为前端模拟。
- 页面位置：`src/components/DataPreprocessing.tsx`，规则配置位于“选择数据集→字段选择→规则配置”流程的第三步。
- 现有模式：已有多类清洗规则（缺失值填充、编码、去重、数值变换、采样等），通过 `CleaningRule` 接口统一管理；每条规则在 UI 面板中独立配置与启用。
- 依赖：字段信息来源于当前选择的数据集及版本；多数据源场景下存在聚合字段显示与编辑逻辑。

## 2. 需求理解与范围（更新为公共字段选择）
- 规则类型：`data_merge`（数据合并）。
- 能力：
  - 主/从数据集与版本来源于 Step2 选择（不在面板展示，仅用于计算公共字段候选项与类型校验）。
  - 将原“多行主/从字段映射”改造为“单一公共字段”下拉选择：候选项为主/从数据集字段名的交集，且类型需兼容（相同或 文本↔分类）。
  - 必须选择合并方式（`Inner`、`Left`、`Outer`）。
  - 校验：未选择或选择了无效公共字段时禁止提交；类型不兼容亦禁止；未选择合并方式禁止提交。
  - 全局提交控制：若任一启用的 `data_merge` 规则不合法，禁用“开始执行数据处理”。
- 非目标：
  - 不实现真实后端合并算法与落库；
  - 不提供多数据集同时产生新数据集的实际写入；
  - 不处理复杂的多键类型转换（例如时间戳↔日期字符串自动转换）。

## 3. 智能决策策略
- 复用现有字段信息与版本选择状态；公共字段候选项由主/从字段交集 + 类型兼容计算得到。
- 无公共字段时在面板内提示并禁用公共字段选择与提交按钮。
- 提交按钮的禁用逻辑在统一入口 `handleApply` 的 disabled 条件中对 `data_merge` 规则进行公共字段与合并方式的校验。
- UI 文案与样式对齐现有规则面板，保持一致的布局与行为。

## 4. 疑问清单（已决/待决）
- [已决] 主/从数据集来源：沿用 Step2 选择的主/从集合与版本；若缺省则使用当前激活项。
- [已决] 类型兼容：text↔category 视为兼容；数值与文本不兼容；
- [已决] 无公共字段时：提示“暂无公共字段可用于合并”；禁用提交。
- [待决] Outer 合并的前端展示策略：原型阶段以文案说明为主，不做实际数据补齐演示。

## 5. 质量门控
- 需求边界清晰、无歧义；
- 技术实现与组件架构对齐（复用既有模式与状态源）；
- 验收标准可测试（三种合并方式、公共字段选择与类型校验、全局提交禁用）；
- 假设已明确（仅前端原型，不做真实数据写入）。